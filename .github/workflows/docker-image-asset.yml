name: docker-openmetadata-server release app
on:
  workflow_dispatch:
    inputs:
      docker_release_tag:
        description: "Server Docker Image Tag"
        required: true

jobs:
  maven-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Install antlr cli
        run: sudo make install_antlr_cli

      - name: Build OpenMetadata Server Application
        run: mvn -DskipTests clean package

      - name: Upload OpenMetadata binary
        uses: actions/upload-artifact@v4
        with:
          name: openmetadata-binary
          path: openmetadata-dist/target/*.tar.gz

  build-and-export-docker-image:
    runs-on: ubuntu-latest
    needs: maven-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download OpenMetadata binary
        uses: actions/download-artifact@v4
        with:
          name: openmetadata-binary
          path: openmetadata-dist/target/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (locally, no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/docker-compose-quickstart/Dockerfile
          tags: openmetadata/server:${{ github.event.inputs.docker_release_tag }}
          push: false  # 关键：不推送到 registry
          load: true   # 将镜像加载到本地 Docker daemon

      - name: Save Docker image as tar
        run: |
          IMAGE_NAME=openmetadata/server:${{ github.event.inputs.docker_release_tag }}
          TAR_FILE=openmetadata-server-${{ github.event.inputs.docker_release_tag }}.tar
          echo "Saving $IMAGE_NAME to $TAR_FILE..."
          docker save $IMAGE_NAME -o $TAR_FILE
          gzip $TAR_FILE
          ls -lh openmetadata-server-${{ github.event.inputs.docker_release_tag }}.tar.gz

      - name: Upload Docker image tar.gz to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openmetadata-docker-image
          path: openmetadata-server-${{ github.event.inputs.docker_release_tag }}.tar.gz

  attach-to-release:
    runs-on: ubuntu-latest
    needs: [maven-build, build-and-export-docker-image]
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: openmetadata-docker-image
          path: .

      - name: Fetch Release Upload URL
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: get_release
        run: |
          TAG="${{ github.event.inputs.docker_release_tag }}-release"
          UPLOAD_URL=$(curl \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/open-metadata/OpenMetadata/releases/tags/$TAG" \
            | jq -r '.upload_url // empty')
          if [ -z "$UPLOAD_URL" ]; then
            echo "Release not found for tag $TAG. Creating one..."
            CREATE_RES=$(curl \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/open-metadata/OpenMetadata/releases \
              -d '{"tag_name":"'"$TAG"'","name":"Release '"$TAG"'","body":"Auto-generated release"}')
            UPLOAD_URL=$(echo "$CREATE_RES" | jq -r '.upload_url')
          fi
          echo "UPLOAD_URL=${UPLOAD_URL%{*}}" >> $GITHUB_OUTPUT

      - name: Upload Docker image to GitHub Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.UPLOAD_URL }}
          asset_path: ./openmetadata-server-${{ github.event.inputs.docker_release_tag }}.tar.gz
          asset_name: openmetadata-server-${{ github.event.inputs.docker_release_tag }}.tar.gz
          asset_content_type: application/gzip
